<!DOCTYPE html>
<html>
<head>
    <title>RUBI Cube Control</title>
    <style>
        body { font-family: sans-serif; }
        .faces-row { display: flex; gap: 20px; margin-bottom: 20px; }
        table { border-collapse: collapse; }
        td { border: 1px solid #333; padding: 0; width: 30px; height: 30px; text-align: center; }
        input { width: 100%; height: 100%; border: none; text-align: center; font-weight: bold; }
        button { margin: 5px; padding: 10px; }
        h3 { text-align: center; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>RUBI Cube Control</h1>

    <button id="btn-angle1">Capture Angle1 (U,L,F)</button>
    <button id="btn-angle2">Capture Angle2 (D,R,B)</button>
    <button id="btn-solve">Solve Cube</button>
    <button id="btn-scramble">Scramble Cube</button>

    <h2>Faces Table (Editable)</h2>
    <div id="faces-container"></div>

    <h2>Kociemba String & Moves</h2>
    <pre id="solution"></pre>

    <script>
        window.onload = function() {
            const centers = { 'U':'Y', 'R':'O', 'F':'G', 'D':'W', 'L':'R', 'B':'B' };

            const colorMap = {
                'W':'#FFFFFF', 'Y':'#FFFF00', 'R':'#FF0000',
                'O':'#FFA500', 'G':'#00FF00', 'B':'#0000FF', '?':'#888888'
            };

            // Draw a row of faces for a single angle capture
function displayFaces(faces, angleLabel) {
    // Determine row container for this angle
    let rowDiv = document.querySelector(`[data-angle='${angleLabel}']`);
    if (!rowDiv) {
        rowDiv = document.createElement('div');
        rowDiv.className = 'faces-row';
        rowDiv.setAttribute('data-angle', angleLabel);
        if (angleLabel === 'angle1') {
            // Top row
            document.getElementById('faces-container').prepend(rowDiv);
        } else {
            // Bottom row
            document.getElementById('faces-container').appendChild(rowDiv);
        }
    } else {
        // Clear previous contents if already exists
        rowDiv.innerHTML = '';
    }

    for (const face in faces) {
        const tableDiv = document.createElement('div');
        tableDiv.innerHTML = `<h3>Face ${face}</h3><table></table>`;
        const table = tableDiv.querySelector('table');

        const scanned = faces[face].colors; // 8 tiles
        let tileIndex = 0;
        for (let row = 0; row < 3; row++) {
            const tr = document.createElement('tr');
            for (let col = 0; col < 3; col++) {
                const td = document.createElement('td');
                const input = document.createElement('input');

                if (row === 1 && col === 1) {
                    input.value = centers[face];
                    input.readOnly = true;
                } else {
                    input.value = scanned[tileIndex];
                    tileIndex++;
                }

                input.style.backgroundColor = colorMap[input.value] || '#888888';
                td.appendChild(input);
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        rowDiv.appendChild(tableDiv);
    }

    attachDynamicColoring();
}

            // Add dynamic color change when a tile is edited
            function attachDynamicColoring() {
                const inputs = document.querySelectorAll('#faces-container input');
                inputs.forEach(input => {
                    if (!input.readOnly) {
                        input.addEventListener('input', (e) => {
                            const val = e.target.value.toUpperCase();
                            e.target.style.backgroundColor = colorMap[val] || '#888888';
                        });
                    }
                });
            }

            // Angle capture buttons
            function captureAngle1() {
                fetch('/capture_angle1', {method:'POST'})
                .then(res => res.json())
                .then(data => {
                    if(data.success) displayFaces(data.faces, "angle1");
                    else alert(data.message);
                });
            }

            function captureAngle2() {
                fetch('/capture_angle2', {method:'POST'})
                .then(res => res.json())
                .then(data => {
                    if(data.success) displayFaces(data.faces, "angle2");
                    else alert(data.message);
                });
            }

            // Solve button
            function solveCube() {
                let faces = {};
                const faceDivs = document.querySelectorAll('#faces-container .faces-row div');
                faceDivs.forEach(div => {
                    const face = div.querySelector('h3').textContent.split(" ")[1];
                    faces[face] = { colors: [] };
                    const inputs = div.querySelectorAll('input');
                    inputs.forEach(input => {
                        if(!input.readOnly) faces[face].colors.push(input.value);
                    });
                });

                fetch('/solve', {
                    method:'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({faces: faces})
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('solution').textContent =
                        `Kociemba: ${data.kociemba}\nMoves: ${data.moves.join(' ')}`;
                });
            }

            // Scramble button
            function scrambleCube() {
                fetch('/scramble', {method:'POST'})
                .then(res => res.json())
                .then(data => {
                    if(data.success) alert("Scramble sent!");
                });
            }

            document.getElementById('btn-angle1').onclick = captureAngle1;
            document.getElementById('btn-angle2').onclick = captureAngle2;
            document.getElementById('btn-solve').onclick = solveCube;
            document.getElementById('btn-scramble').onclick = scrambleCube;
        }
    </script>
</body>
</html>
